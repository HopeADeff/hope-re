name: Upload Model Binaries

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS objects
        run: git lfs pull

      - name: Validate ONNX files are real binaries
        run: |
          count=$(find src-models/models -name '*.onnx' -type f | wc -l)
          if [ "$count" -eq 0 ]; then
            echo "::error::No .onnx files found in src-models/models/"
            exit 1
          fi
          for f in src-models/models/*.onnx; do
            if head -c 40 "$f" | grep -q "version https://git-lfs"; then
              echo "::error::$f is an LFS pointer, not a real binary. Run 'git lfs push --all origin' locally first."
              exit 1
            fi
          done
          echo "Found $count ONNX model(s):"
          ls -lh src-models/models/*.onnx

      - name: Delete existing release if present
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release delete models-latest --yes --cleanup-tag 2>/dev/null || true

      - name: Create release and upload models
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create models-latest \
            --title "Model Binaries" \
            --notes "ONNX model binaries for Hope-RE.

          Updated on $(date -u +'%Y-%m-%d %H:%M UTC')." \
            --latest=false \
            src-models/models/*.onnx
