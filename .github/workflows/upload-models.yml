name: upload models

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  upload:
    if: startsWith(github.event.release.tag_name, 'hope-v')
    runs-on: ubuntu-latest

    steps:
      - name: Checkout with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS objects
        run: git lfs pull

      - name: Validate ONNX files are real binaries
        run: |
          count=$(find src-models/models -name '*.onnx' -type f | wc -l)
          if [ "$count" -eq 0 ]; then
            echo "::error::No .onnx files found in src-models/models/"
            exit 1
          fi
          for f in src-models/models/*.onnx; do
            if head -c 40 "$f" | grep -q "version https://git-lfs"; then
              echo "::error::$f is an LFS pointer, not a real binary. Run 'git lfs push --all origin' locally first."
              exit 1
            fi
          done
          echo "Found $count ONNX model(s):"
          ls -lh src-models/models/*.onnx

      - name: Upload models to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ github.event.release.tag_name }}" src-models/models/*.onnx --clobber
