name: publish

on:
  push:
    branches:
      - main

jobs:
  publish-tauri:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            args: --target aarch64-apple-darwin

          - platform: windows-latest
            args: ""
            arch: x86_64

          - platform: ubuntu-24.04
            args: ""
            arch: amd64

          - platform: ubuntu-24.04-arm
            args: ""
            arch: arm64

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: 24.x

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin' || '' }}

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --fix-missing \
            libwebkit2gtk-4.1-0=2.44.0-2 \
            libwebkit2gtk-4.1-dev=2.44.0-2 \
            libjavascriptcoregtk-4.1-0=2.44.0-2 \
            libjavascriptcoregtk-4.1-dev=2.44.0-2 \
            gir1.2-javascriptcoregtk-4.1=2.44.0-2 \
            gir1.2-webkit2-4.1=2.44.0-2 \
            libgtk-3-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            xdg-utils

      - name: Install frontend dependencies
        run: pnpm install

      - name: Get Version
        id: get_version
        shell: bash
        run: echo "VERSION=$(jq -r .version package.json)" >> $GITHUB_OUTPUT

      - name: Get Release Notes
        id: release_notes
        shell: bash
        run: |
          VERSION="${{ steps.get_version.outputs.VERSION }}"
          # Extract changelog entry using awk
          # Looks for line starting with "## [VERSION]" and prints until next line starting with "## "
          NOTES=$(awk -v ver="[$VERSION]" '/^## / { if (p) { exit }; if ($2 == ver) { p=1; next } } p' CHANGELOG.md)

          if [ -z "$NOTES" ]; then
            NOTES="See the assets to download this version and install."
          fi

          # Output multiline string to GITHUB_OUTPUT
          {
            echo "BODY<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        with:
          tagName: __VERSION__
          releaseName: Hope v__VERSION__
          releaseBody: ${{ steps.release_notes.outputs.BODY }}
          releaseDraft: false
          prerelease: false
          updaterJsonPreferNsis: true
          args: ${{ matrix.args }}
          tauriScript: pnpm tauri

  upload-models:
    needs: publish-tauri
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout with LFS
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Pull LFS objects
        run: git lfs pull

      - name: Read version from tauri.conf.json
        id: version
        run: |
          TAG="$(jq -r '.version' src-tauri/tauri.conf.json)"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Validate ONNX files are real binaries
        run: |
          count=$(find src-models/models -name '*.onnx' -type f | wc -l)
          if [ "$count" -eq 0 ]; then
            echo "::error::No .onnx files found in src-models/models/"
            exit 1
          fi
          for f in src-models/models/*.onnx; do
            if head -c 40 "$f" | grep -q "version https://git-lfs"; then
              echo "::error::$f is an LFS pointer, not a real binary. Run 'git lfs push --all origin' locally first."
              exit 1
            fi
          done
          echo "Found $count ONNX model(s):"
          ls -lh src-models/models/*.onnx

      - name: Upload models to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ steps.version.outputs.tag }}" src-models/models/*.onnx --clobber
